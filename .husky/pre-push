#!/bin/sh
. "$(dirname "$0")/_/husky.sh"


# lint
#   - if pushing changes to .js|jsx|ts|tsx files: run eslint and prettier
#   - if pushing changes to .css|scss files: run stylelint

echo 'ğŸ—ï¸ğŸ‘· Styling, testing and type-checking project before committing'

set -e

remote="$1"
url="$2"
z40=0000000000000000000000000000000000000000

while read local_ref local_sha remote_ref remote_sha
do
  if [ "$local_sha" = $z40 ]; then
    # branch deleted
    :
  else
    if [ "$remote_sha" = $z40 ]; then
      codelint=1
      stylelint=1
    else
      range="$remote_sha..$local_sha"
      files=`git diff --name-only $range`

      [ -n "`echo $files | grep \.(js|jsx|ts|tsx)$`" ] && codelint=1
      [ -n "`echo $files | grep \.(css|scss)$`" ] && stylelint=1
    fi

    if [[ $codelint -eq 1 ]]; then
      # Check ESLint Standards
      pnpm check-eslint ||
      (
        echo 'ğŸ˜¤ğŸ€ğŸ‘‹ğŸ˜¤ ESLint Check Failed. Make the required changes listed above, add changes and try to commit again.'
        false;
      )

      # Check tsconfig standards
      pnpm check-types ||
      (
        echo 'ğŸ¤¡ğŸ˜‚âŒğŸ¤¡ Failed Type check. Make the changes required above.'
        false;
      )
    else
      echo 'ğŸš´â€â™‚ï¸ No need to check eslint and tsconfigs.'
    fi

    if [[ $stylelint -eq 1 ]]; then
      # Check stylelint
      pnpm check-stylelint ||
      (
        echo 'â˜€ï¸ğŸ§–â€â™€ï¸ğŸ‘—ğŸ’„ StyleLint Check Failed. Make the required changes listed above, add changes and try to commit again.'
        false;
      )
    else
      echo 'ğŸš´ğŸš´â€â™€ï¸ No need to check stylelint.'
    fi
  fi
done

# If everything passes... Now we can push
echo 'âœ…âœ…âœ…âœ… All checks passed. Pushing this now. âœ…âœ…âœ…âœ…'

exit 0


# echo 'ğŸ—ï¸ğŸ‘· Styling, testing and type-checking project before committing'

# # Check Prettier standards
# # pnpm check-format ||
# # (
# #   echo 'ğŸ’„ğŸ’„ğŸ’„ğŸ’„ Prettier Check Failed. \n\nRun: yarn format \n\nadd changes and try commit again.';
# #   false;
# # )

# # Check stylelint
# pnpm check-stylelint ||
# (
#   echo 'â˜€ï¸ğŸ§–â€â™€ï¸ğŸ‘—ğŸ’„ StyleLint Check Failed. Make the required changes listed above, add changes and try to commit again.'
#   false;
# )

# # Check ESLint Standards
# pnpm check-eslint ||
# (
#   echo 'ğŸ˜¤ğŸ€ğŸ‘‹ğŸ˜¤ ESLint Check Failed. Make the required changes listed above, add changes and try to commit again.'
#   false;
# )

# # Check tsconfig standards
# pnpm check-types ||
# (
#   echo 'ğŸ¤¡ğŸ˜‚âŒğŸ¤¡ Failed Type check. Make the changes required above.'
#   false;
# )

# # If everything passes... Now we can commit
# # echo 'ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”... Alright... Code looks good... Trying to Build now.#ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”'

# # build project if needed
# # pnpm build ||
# # (
# #    echo 'âŒğŸ‘·ğŸ”¨âŒ Build failed: View the errors above to see why.'
# #    false;
# # )

# # If everything passes... Now we can push
# echo 'âœ…âœ…âœ…âœ… All checks passed. Pushing this now. âœ…âœ…âœ…âœ…'
